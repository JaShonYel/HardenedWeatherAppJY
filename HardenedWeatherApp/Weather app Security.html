<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="text-center mb-4">
            <h1 class="display-4">Weather App</h1>
            <p class="lead">Enter your ZIP code to see the weather forecast:</p>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="zipcode" class="form-control" placeholder="Enter ZIP code">
                    <button class="btn btn-primary" onclick="getWeather()">Get Weather</button>
                </div>
            </div>
        </div>
        <div id="weather" class="row justify-content-center"></div>
    </div>

    <script src="./config.js"></script>
    <script>
        let attempts = 0;

        async function getWeather() {
            const zipcode = document.getElementById('zipcode').value;
            console.log(zipcode);

            // Validate that the input is a 5-digit number
            const zipRegex = /^\d{5}$/;
            if (!zipRegex.test(zipcode)) {
                attempts++;
                let annoyance = '';
                switch (attempts) {
                    case 1:
                        annoyance = "EHH.. WHATS UP DOC?";
                        break;
                    case 2:
                        annoyance = "Come on, I need a valid ZIP code!";
                        break;
                    case 3:
                        annoyance = "Seriously? A valid ZIP code, please!";
                        break;
                    case 4:
                        annoyance = "You've got to be kidding me. ZIP code. Now.";
                        break;
                    case 5:
                        annoyance = "I'M LOSING MY PATIENCE. VALID ZIP CODE. NOW.";
                        break;
                    default:
                        annoyance = "It's over, Anakin. I have the high ground.";
                        break;
                }
                alert(annoyance);
                console.log("Invalid ZIP code");
                return false;
            }

            const zip = zipcode;
            console.log(zip);

            const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?zip=${zip},us&units=imperial&cnt=24&appid=${apiKey}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch weather data.');
                }

                const data = await response.json();
                displayWeather(data);

                // fetch for logging we've all seen these before
                const logResponse = await fetch('http://localhost:3000/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zip, weatherData: data })
                });

                if (!logResponse.ok) {
                    throw new Error('Failed to log weather data.');
                }

                alert("Thank you, here is your weather");
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function displayWeather(data) {
            const weatherDiv = document.getElementById('weather');
            weatherDiv.replaceChildren(); 
            const days = {};
            data.list.forEach(entry => {
                const date = new Date(entry.dt_txt).toLocaleDateString();
                if (!days[date]) {
                    days[date] = [];
                }
                days[date].push(entry);
            });

            const dayKeys = Object.keys(days).slice(0, 3);

            const title = document.createElement('h2');
            title.className = 'text-center mb-4';
            title.textContent = 'Weather Forecast';
            weatherDiv.appendChild(title);

            dayKeys.forEach(date => {
                const entries = days[date];
                const temps = entries.map(e => e.main.temp);
                const avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;

                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';

                const card = document.createElement('div');
                card.className = 'card h-100';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const cardTitle = document.createElement('h5');
                cardTitle.textContent = date;

                const avgTempText = document.createElement('p');
                avgTempText.className = 'card-text';
                avgTempText.textContent = `Average Temperature: ${avgTemp.toFixed(1)}Â°F`;

                const descriptionText = document.createElement('p');
                descriptionText.className = 'card-text text-capitalize';
                descriptionText.textContent = entries[0].weather[0].description;

                cardBody.appendChild(cardTitle);
                cardBody.appendChild(avgTempText);
                cardBody.appendChild(descriptionText);
                card.appendChild(cardBody);
                col.appendChild(card);
                weatherDiv.appendChild(col);
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>